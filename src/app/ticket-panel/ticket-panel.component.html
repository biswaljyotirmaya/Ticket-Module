<div class="container py-5">
  <div class="card shadow-lg rounded-4 border-0 animate__animated animate__fadeIn" style="border: 2px solid #0dcaf0;">
    <div class="card-body p-4">
      <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
        <span class="badge bg-gradient bg-dark px-4 py-2 fs-6 rounded-pill">Task</span>
        <span class="text-muted small fw-bold">#{{ ticket.id }}</span>
        <button class="btn btn-sm btn-outline-primary ms-auto rounded-pill transition-all" type="button">
          <i class="bi bi-robot me-1"></i> Ask AI
        </button>
      </div>

      <h4 class="fw-bold mb-4 bg-gradient bg-info-subtle text-info p-3 rounded-2">
        <i class="bi bi-ticket-perforated-fill me-2 text-warning"></i>
        {{ ticket.titleTicket || ticket.title }}
      </h4>

      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 gy-4 mb-5">
        <div>
          <div class="text-muted small fw-medium">Status</div>
          <span class="fw-semibold text-dark">{{ ticket.status || 'Mark Complete' }}</span>
        </div>
        <div>
          <div class="text-muted small fw-medium">Assignee</div>
          <span class="fw-semibold text-dark">{{ ticket.assign || ticket.assignee || 'Empty' }}</span>
        </div>
        <div>
          <div class="text-muted small fw-medium">Priority</div>
          <span class="fw-semibold text-dark">{{ ticket.priority || 'Empty' }}</span>
        </div>
        <div>
          <div class="text-muted small fw-medium">Date</div>
          <span class="fw-semibold text-dark">
            {{ (ticket.dateCurrent || ticket.date) ? ((ticket.dateCurrent || ticket.date) | date) : 'Empty' }}
          </span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <ul class="list-unstyled">
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-circle-half me-2 text-primary"></i>
              <strong class="me-2">Status</strong>
              <span class="badge bg-primary rounded-pill">{{ ticket.status }}</span>
              <i class="bi bi-check-circle-fill ms-2 text-muted"></i>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-calendar-event me-2 text-primary"></i>
              <strong class="me-2">Dates</strong>
              <span class="fw-medium">
                {{ (ticket.dateCurrent || ticket.date) ? ((ticket.dateCurrent || ticket.date) | date) : 'Empty' }}
              </span>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-hourglass-split me-2 text-primary"></i>
              <strong class="me-2">Time Estimate</strong>
              <span class="text-muted">Empty</span>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-stopwatch me-2 text-primary"></i>
              <strong class="me-2">Track Time</strong>
              <span class="text-muted"><i class="bi bi-circle me-1"></i>Add time</span>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-diagram-3 me-2 text-primary"></i>
              <strong class="me-2">Relationships</strong>
              <span class="text-muted">Empty</span>
            </li>
          </ul>
        </div>

        <div class="col-md-4">
          <ul class="list-unstyled">
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-person-fill me-2 text-primary"></i>
              <strong class="me-2">Assignees</strong>
              <div class="d-flex">
                <span *ngIf="ticket.assign || ticket.assignee" class="badge rounded-circle bg-warning text-white me-1 p-2">
                  {{ (ticket.assign || ticket.assignee)?.toString().slice(0, 1).toUpperCase() }}
                </span>
                <span *ngIf="!ticket.assign && !ticket.assignee" class="text-muted">Empty</span>
              </div>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-flag-fill text-danger me-2"></i>
              <strong class="me-2">Priority</strong>
              <span [ngClass]="{
                  'text-danger': ticket.priority === 'High',
                  'text-warning': ticket.priority === 'Medium',
                  'text-success': ticket.priority === 'Low'
                }" class="fw-bold">{{ ticket.priority }}</span>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-lightning-charge me-2 text-primary"></i>
              <strong class="me-2">Sprint Points</strong>
              <span class="text-muted">Empty</span>
            </li>
            <li class="mb-4 d-flex align-items-center">
              <i class="bi bi-tag me-2 text-primary"></i>
              <strong class="me-2">Tags</strong>
              <span class="text-muted">Empty</span>
            </li>
          </ul>
        </div>
      </div>

      <ul class="nav nav-tabs mt-5 mb-4 border-0" id="ticketDetailTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active fw-semibold rounded-top-3" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">
            Description
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold rounded-top-3" id="subtasks-tab" data-bs-toggle="tab" data-bs-target="#subtasks" type="button" role="tab" aria-controls="subtasks" aria-selected="false">
            Subtasks
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold rounded-top-3" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button" role="tab" aria-controls="links" aria-selected="false">
            Links & Relationships
          </button>
        </li>
      </ul>

      <div class="tab-content pt-4" id="ticketDetailTabsContent">
        <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="text-muted small fw-medium">Instructions / Description</label>
            <span *ngIf="saving" class="text-success small fw-medium">
              <i class="bi bi-check-circle-fill me-1"></i> Saving...
            </span>
          </div>
          <quill-editor [(ngModel)]="ticket.description" (onContentChanged)="onContentChanged($event)" [styles]="{
              'min-height': '200px',
              'background-color': '#ffffff',
              'border': '1px solid #dee2e6',
              'border-radius': '0.5rem',
              'padding': '10px'
            }">
          </quill-editor>

          <div class="d-flex align-items-center justify-content-between text-muted small mt-3">
            <div class="d-flex align-items-center">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/OpenAI_Logo.svg/120px-OpenAI_Logo.svg.png" alt="AI" width="24" height="24" class="me-2" />
              Write with AI
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary rounded-pill transition-all" (click)="downloadPdf()" type="button">
                Download PDF
              </button>
              <button class="btn btn-sm btn-outline-primary rounded-pill transition-all" (click)="downloadDocx()" type="button">
                Download DOCX
              </button>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="subtasks" role="tabpanel" aria-labelledby="subtasks-tab">
          <h6 class="mb-4 fw-bold">Subtasks</h6>
          <div class="input-group mb-4 flex-wrap gap-3">
            <input type="text" class="form-control form-control-sm rounded-3" placeholder="Add a new subtask title" [(ngModel)]="newSubTask.titleTicket" />
            <input type="text" class="form-control form-control-sm rounded-3" placeholder="Assignee" [(ngModel)]="newSubTask.assign" />
            <select class="form-select form-select-sm rounded-3" [(ngModel)]="newSubTask.status">
              <option value="">Select Status</option>
              <option value="Open">To Do</option>
              <option value="In Progress">In Progress</option>
              <option value="Closed">Completed</option>
            </select>
            <select class="form-select form-select-sm rounded-3" [(ngModel)]="newSubTask.priority">
              <option value="">Select Priority</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
            <button class="btn btn-primary btn-sm rounded-pill transition-all" (click)="createSubTicket()" [disabled]="
                !newSubTask.titleTicket ||
                !newSubTask.assign ||
                !newSubTask.status ||
                !newSubTask.priority
              " type="button">
              Add Subtask
            </button>
          </div>

          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 rounded-3 mb-2 shadow-sm" *ngFor="let sub of subTickets">
              <div>
                <strong>
                  <a href="#" (click)="goToTicketPanel(sub.id); $event.preventDefault()" class="fw-semibold text-decoration-none text-primary">
                    {{ sub.titleTicket || sub.title }}
                  </a>
                </strong>
                <span class="text-muted small">
                  - Assignee: {{ sub.assign || sub.assignee }} -
                  Status: {{ sub.status }} -
                  Priority: {{ sub.priority }}
                  ({{ sub.dateCurrent | date : 'yyyy-MM-dd' }})
                </span>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-warning btn-sm rounded-circle" (click)="openEditSubTicketModal(sub)" title="Edit Subtask" type="button">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm rounded-circle" (click)="confirmDeleteSubTicket(sub.id)" title="Delete Subtask" type="button">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </li>
            <li *ngIf="subTickets.length === 0" class="list-group-item text-muted border-0 rounded-3">
              No subtasks yet.
            </li>
          </ul>
        </div>

        <div class="tab-pane fade" id="links" role="tabpanel" aria-labelledby="links-tab">
          <h5 class="fw-bold mb-4">External Links</h5>
          <div class="input-group mb-4 flex-wrap gap-3">
            <input type="url" class="form-control form-control-sm rounded-3" placeholder="e.g., https://docs.google.com/..." [(ngModel)]="newLink.url" />
            <input type="text" class="form-control form-control-sm rounded-3" placeholder="Description (Optional)" [(ngModel)]="newLink.description" />
            <button class="btn btn-primary btn-sm rounded-pill transition-all" (click)="addLink()" [disabled]="!newLink.url" type="button">
              Add Link
            </button>
          </div>
          <ul class="list-group mb-4">
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 rounded-3 mb-2 shadow-sm" *ngFor="let link of links">
              <div>
                <a [href]="link.url" target="_blank" rel="noopener noreferrer" class="fw-semibold text-decoration-none text-primary">
                  {{ link.url }}
                </a>
                <p *ngIf="link.description" class="text-muted small mb-0">
                  {{ link.description }}
                </p>
              </div>
              <button class="btn btn-outline-danger btn-sm rounded-circle" (click)="confirmDeleteLink(link.id)" title="Remove Link" type="button">
                <i class="bi bi-trash"></i>
              </button>
            </li>
            <li *ngIf="links.length === 0" class="list-group-item text-muted border-0 rounded-3">
              No links added yet.
            </li>
          </ul>

          <h5 class="fw-bold mb-4">Relationships to other Tickets</h5>
          <div class="mb-4">
            <label class="form-label fw-medium" for="relationshipTypeSelect">Relationship Type</label>
            <select id="relationshipTypeSelect" class="form-select form-select-sm rounded-3 mb-3" [(ngModel)]="newRelationship.type">
              <option value="">Select Type</option>
              <option *ngFor="let type of relationshipTypes" [value]="type">{{ type }}</option>
            </select>

            <label class="form-label fw-medium" for="targetTicketSearch">Target Ticket</label>
            <div class="input-group mb-3">
              <input id="targetTicketSearch" type="text" class="form-control form-control-sm rounded-3" placeholder="Search by title or ID" [(ngModel)]="searchTargetTicketQuery" (ngModelChange)="searchTickets()" />
              <button class="btn btn-secondary btn-sm rounded-3" [disabled]="!selectedTargetTicket" (click)="selectedTargetTicket = null; searchTargetTicketQuery = ''" type="button">
                Clear
              </button>
            </div>
            <div class="list-group mt-1" *ngIf="searchTicketResults.length > 0">
              <button type="button" class="list-group-item list-group-item-action border-0 rounded-3 mb-1 shadow-sm" *ngFor="let result of searchTicketResults" (click)="selectTargetTicket(result)">
                #{{ result.id }} - {{ result.titleTicket }}
              </button>
            </div>
            <p *ngIf="selectedTargetTicket" class="text-success small mt-2 fw-medium">
              Selected: #{{ selectedTargetTicket.id }} - {{ selectedTargetTicket.titleTicket }}
            </p>
          </div>

          <button class="btn btn-primary btn-sm rounded-pill transition-all mb-4" (click)="addRelationship()" [disabled]="!newRelationship.type || !selectedTargetTicket" type="button">
            Add Relationship
          </button>

          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 rounded-3 mb-2 shadow-sm" *ngFor="let rel of relationships">
              <div>
                <strong class="text-dark">{{ rel.type }}</strong>  
                <a [routerLink]="['/ticket', rel.targetTicket?.id]" class="fw-semibold text-decoration-none text-primary">
                  #{{ rel.targetTicket?.id }} - {{ rel.targetTicket?.titleTicket }}
                </a>
              </div>
              <button class="btn btn-outline-danger btn-sm rounded-circle" (click)="confirmDeleteRelationship(rel.id)" title="Remove Relationship" type="button">
                <i class="bi bi-trash"></i>
              </button>
            </li>
            <li *ngIf="relationships.length === 0" class="list-group-item text-muted border-0 rounded-3">
              No relationships added yet.
            </li>
          </ul>
        </div>
      </div>

      <div class="border-top mt-5 pt-4">
        <h6 class="mb-3 fw-bold">Custom Fields</h6>
        <button class="btn btn-sm btn-outline-primary rounded-pill transition-all" type="button">
          <i class="bi bi-plus"></i> Create Custom Field
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="text-center my-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted fw-medium">Loading ticket details...</p>
  </div>
</ng-template>

<!-- Edit Subticket Modal -->
<div class="modal fade" id="editSubTicketModal" tabindex="-1" aria-labelledby="editSubTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-gradient bg-primary text-white">
        <h5 class="modal-title fw-bold" id="editSubTicketModalLabel">Edit Subticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label fw-medium" for="editSubTaskTitle">Title</label>
            <input id="editSubTaskTitle" [(ngModel)]="editingSubTask.titleTicket" class="form-control form-control-sm rounded-3" type="text" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-medium" for="editSubTaskAssign">Assignee</label>
            <input id="editSubTaskAssign" [(ngModel)]="editingSubTask.assign" class="form-control form-control-sm rounded-3" type="text" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-medium" for="editSubTaskStatus">Status</label>
            <select id="editSubTaskStatus" [(ngModel)]="editingSubTask.status" class="form-select form-select-sm rounded-3">
              <option value="Open">To Do</option>
              <option value="In Progress">In Progress</option>
              <option value="Closed">Completed</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-medium" for="editSubTaskPriority">Priority</label>
            <select id="editSubTaskPriority" [(ngModel)]="editingSubTask.priority" class="form-select form-select-sm rounded-3">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-medium" for="editSubTaskDate">Date</label>
            <input id="editSubTaskDate" type="date" [(ngModel)]="editingSubTask.dateCurrent" class="form-control form-control-sm rounded-3" />
          </div>
          <div class="col-md-12">
            <label class="form-label fw-medium" for="editSubTaskDescription">Description</label>
            <textarea id="editSubTaskDescription" [(ngModel)]="editingSubTask.description" rows="3" class="form-control form-control-sm rounded-3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-dismiss="modal" type="button">
          Cancel
        </button>
        <button class="btn btn-primary btn-sm rounded-pill transition-all" (click)="updateSubTicket()" data-bs-dismiss="modal" type="button">
          Update
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Subticket Confirm Modal -->
<div class="modal fade" id="deleteSubTicketConfirmModal" tabindex="-1" aria-labelledby="deleteSubTicketConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-gradient bg-danger text-white">
        <h5 class="modal-title fw-bold" id="deleteSubTicketConfirmModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
        <p class="mt-3 mb-0 fw-medium">Are you sure you want to delete this subtask?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-dismiss="modal" type="button">
          Cancel
        </button>
        <button class="btn btn-danger btn-sm rounded-pill transition-all" (click)="deleteSubTicket()" data-bs-dismiss="modal" type="button">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Link Confirm Modal -->
<div class="modal fade" id="deleteLinkConfirmModal" tabindex="-1" aria-labelledby="deleteLinkConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-gradient bg-danger text-white">
        <h5 class="modal-title fw-bold" id="deleteLinkConfirmModalLabel">Confirm Link Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
        <p class="mt-3 mb-0 fw-medium">Are you sure you want to delete this link?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-dismiss="modal" type="button">
          Cancel
        </button>
        <button class="btn btn-danger btn-sm rounded-pill transition-all" (click)="deleteLink()" data-bs-dismiss="modal" type="button">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Relationship Confirm Modal -->
<div class="modal fade" id="deleteRelationshipConfirmModal" tabindex="-1" aria-labelledby="deleteRelationshipConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-gradient bg-danger text-white">
        <h5 class="modal-title fw-bold" id="deleteRelationshipConfirmModalLabel">Confirm Relationship Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
        <p class="mt-3 mb-0 fw-medium">Are you sure you want to delete this relationship?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-dismiss="modal" type="button">
          Cancel
        </button>
        <button class="btn btn-danger btn-sm rounded-pill transition-all" (click)="deleteRelationship()" data-bs-dismiss="modal" type="button">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>